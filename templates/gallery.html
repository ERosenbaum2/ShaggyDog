{% extends "base.html" %}

{% block title %}Gallery - Shaggy Dog{% endblock %}

{% block content %}
<div class="gallery-container">
    <div class="gallery-header">
        <h1>Your Transformations</h1>
        <a href="{{ url_for('upload_page') }}" class="btn btn-primary">Upload New Image</a>
    </div>
    
    {% if images %}
        <div class="gallery-grid">
            {% for image in images %}
            <div class="gallery-item" data-status="{{ image.status }}">
                <div class="gallery-item-header">
                    <h3>{{ image.breed }}</h3>
                    <span class="gallery-date">{{ image.created_at.strftime('%B %d, %Y') }}</span>
                    {% if image.status == 'processing' %}
                        <span class="status-badge processing">Processing...</span>
                    {% elif image.status == 'failed' %}
                        <span class="status-badge failed">Failed</span>
                    {% endif %}
                </div>
                <div class="transformation-sequence" data-image-id="{{ image.id }}">
                    <div class="sequence-item">
                        <h4>Original</h4>
                        <img src="{{ url_for('serve_image', image_id=image.id, image_type='original') }}" 
                             alt="Original" class="transformation-image" loading="lazy">
                    </div>
                    <div class="sequence-item">
                        <h4>Transition 1</h4>
                        {% if image.status == 'processing' or not image.transition1 %}
                            <div class="placeholder">Generating...</div>
                        {% else %}
                            <img src="{{ url_for('serve_image', image_id=image.id, image_type='transition1') }}" 
                                 alt="Transition 1" class="transformation-image" loading="lazy">
                        {% endif %}
                    </div>
                    <div class="sequence-item">
                        <h4>Transition 2</h4>
                        {% if image.status == 'processing' or not image.transition2 %}
                            <div class="placeholder">Generating...</div>
                        {% else %}
                            <img src="{{ url_for('serve_image', image_id=image.id, image_type='transition2') }}" 
                                 alt="Transition 2" class="transformation-image" loading="lazy">
                        {% endif %}
                    </div>
                    <div class="sequence-item">
                        <h4>Final</h4>
                        {% if image.status == 'processing' or not image.final_dog %}
                            <div class="placeholder">Generating...</div>
                        {% else %}
                            <img src="{{ url_for('serve_image', image_id=image.id, image_type='final') }}" 
                                 alt="Final" class="transformation-image" loading="lazy">
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-gallery">
            <p>No transformations yet. Upload your first headshot to get started!</p>
            <a href="{{ url_for('upload_page') }}" class="btn btn-primary">Upload Image</a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Auto-refresh gallery if any images are processing
    const processingItems = document.querySelectorAll('[data-status="processing"]');
    if (processingItems.length > 0) {
        // Refresh page every 10 seconds while images are processing
        setTimeout(() => {
            window.location.reload();
        }, 10000);
    }
    
    // Use Web Workers to load images in parallel for better performance
    if (window.Worker) {
        const images = document.querySelectorAll('.transformation-image');
        const workerUrl = '{{ url_for("static", filename="js/worker.js") }}';
        
        images.forEach((img, index) => {
            const worker = new Worker(workerUrl);
            const originalSrc = img.src;
            
            worker.postMessage({
                type: 'loadImage',
                src: originalSrc,
                index: index
            });
            
            worker.onmessage = function(e) {
                if (e.data.type === 'imageLoaded') {
                    // Update image source with the loaded blob URL
                    img.src = e.data.src;
                    img.style.opacity = '0';
                    img.onload = function() {
                        img.style.transition = 'opacity 0.3s';
                        img.style.opacity = '1';
                    };
                    worker.terminate(); // Clean up worker after use
                } else if (e.data.type === 'imageError') {
                    // Fallback to original src if worker fails
                    console.error('Worker error:', e.data.error);
                    worker.terminate();
                }
            };
        });
    } else {
        // Fallback for browsers without Web Worker support
        console.log('Web Workers not supported, using standard image loading');
    }
</script>
{% endblock %}
